name: Build and Push Docker Image to GitHub Packages

on:
  push:
    branches: [ "develop" ]
  pull_request:
    branches: [ "develop" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # GitHub Packages에 푸시할 수 있도록 권한 부여

    steps:
    # 1. 코드 체크아웃
    - name: Checkout the code
      uses: actions/checkout@v4

    # 2. JDK 17 설정
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Docker 빌드: 멀티스테이지 Dockerfile을 이용해 Docker 이미지 빌드
    - name: Build Docker image
      run: |
        docker build -t ghcr.io/${{ github.repository }}/my-app:${{ github.sha }} .

    # 4. GitHub Container Registry에 로그인
    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    # 5. Docker 이미지 푸시: 빌드된 이미지를 GitHub Packages에 푸시
    - name: Push Docker image to GitHub Packages
      run: |
        docker push ghcr.io/${{ github.repository }}/my-app:${{ github.sha }}

